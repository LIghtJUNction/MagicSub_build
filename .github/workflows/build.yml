name: build
on:
    workflow_dispatch:
    schedule:
      - cron: '0 0 * * *'
permissions:
  contents: write
jobs:
    build:
        name: Build
        runs-on: ubuntu-latest
        steps:
          - uses: actions/setup-python@v4
            with:
             python-version: '3.10'
          - uses: actions/setup-node@v3
            with:
              node-version: '16'
              
          # 后端构建
          - name: Checkout Backend
            run: |
              sudo apt install git wget -y
              git clone https://github.com/sub-store-org/Sub-Store.git
              sed -i 's#https://sub-store.vercel.app/#http://127.0.0.1:3000#g' 'Sub-Store/backend/src/restful/miscs.js'
              
          - name: Build Backend
            run: |
              npm install -g pnpm pkg
              cd Sub-Store/backend
              pnpm i
              pnpm run build
              pnpm run bundle
              
          # 前端构建  
          - name: Checkout Frontend
            run: |
              git clone https://github.com/sub-store-org/Sub-Store-Front-End.git
              sed -i 's#https://sub.store#http://127.0.0.1:3000#g' 'Sub-Store-Front-End/.env.production'
              
          - name: Build Frontend  
            run: |
              cd Sub-Store-Front-End
              pnpm i
              pnpm build
              
          # 整合前后端
          - name: Merge Frontend and Backend
            run: |
              mkdir -p Sub-Store/backend/dist/public
              cp -r Sub-Store-Front-End/dist/* Sub-Store/backend/dist/public/
              
          # 打包成二进制  
          - name: Package Binary
            run: |
              pkg Sub-Store/backend/dist/sub-store.bundle.js \
                --config package.json \
                --targets node16-android-arm64 \
                --output MagicSub
              mkdir -p MyModule/system/bin
              mv MagicSub MyModule/system/bin/MagicSub


          - name: Upload Artifact
            uses: actions/upload-artifact@v3
            with:
              name: MagicSub
              path: MyModule/system/bin/MagicSub

          # 创建Release
          - name: Create Release
            id: create_release
            uses: actions/create-release@v1
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
              tag_name: v${{ github.run_number }}
              release_name: Release v${{ github.run_number }}
              body: |
                MagicSub Release v${{ github.run_number }}
                - 自动构建于 ${{ github.event.head_commit.timestamp }}
              draft: false
              prerelease: false

          # 上传Release资产
          - name: Upload Release Asset
            uses: actions/upload-release-asset@v1
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
              upload_url: ${{ steps.create_release.outputs.upload_url }}
              asset_path: MyModule/system/bin/MagicSub
              asset_name: MagicSub
              asset_content_type: application/octet-stream
