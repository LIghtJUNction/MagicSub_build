name: Build MagicSub

on:
  workflow_dispatch:
    inputs:
      tag:
        description: '发布标签'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  packages: write
  actions: write

env:
  NODE_VERSION: '18.12.1'
  PNPM_VERSION: '8.x'
  SHELL: '/bin/bash'
  NDK_VERSION: 'r27c'  # 添加 NDK 版本
  API_LEVEL: '34'      # 添加 API level
  PYTHON_VERSION: '3.11'

jobs:
  build:
    name: Build MagicSub
    runs-on: ubuntu-latest
    
    steps:

      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Initialize Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false
      
      - name: Create Lock File
        run: |
          echo '{"name":"magicsub-build","version":"1.0.0"}' > package.json
          pnpm install --ignore-scripts
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.NDK_VERSION }}
      - name: Setup Build Tools
        shell: bash  # 指定使用 bash 执行
        run: |
          python3 -V
          pnpm config set strict-peer-dependencies false
          pnpm add -g pkg
          git clone --depth 1 https://github.com/nodejs-mobile/nodejs-mobile.git
          cd nodejs-mobile
          chmod +x ./tools/android_build.sh  # 添加执行权限
          bash ./tools/android_build.sh $ANDROID_NDK_HOME ${{ env.API_LEVEL }} arm64-v8a
  
  
      - name: Clone Repositories
        run: |
          rm -rf Sub-Store Sub-Store-Front-End
          git clone --depth 1 https://github.com/sub-store-org/Sub-Store.git
          git clone --depth 1 https://github.com/sub-store-org/Sub-Store-Front-End.git
      
      - name: Fix Frontend Code
        run: |
          cd Sub-Store-Front-End
          sed -i 's/watch(list,/watch(() => list,/g' src/views/editor/ActionBlock.vue
      
      - name: Build Backend
        run: |
          cd Sub-Store/backend
          sed -i 's#https://sub-store.vercel.app/#http://127.0.0.1:3000#g' src/restful/miscs.js
          pnpm install
          NODE_OPTIONS="--max-old-space-size=4096" pnpm run build
          pnpm run bundle
      
      - name: Build Frontend
        run: |
          cd Sub-Store-Front-End
          sed -i 's#https://sub.store#http://127.0.0.1:3000#g' .env.production
          pnpm install
          NODE_OPTIONS="--max-old-space-size=4096" pnpm build
      
      - name: Package Binary
        run: |
          mkdir -p Sub-Store/backend/dist/public
          cp -r Sub-Store-Front-End/dist/* Sub-Store/backend/dist/public/
          cd Sub-Store/backend/dist
          
          ../../../nodejs-mobile/tools/package.sh \
            --input ./sub-store.bundle.js \
            --output MagicSub \
            --arch arm64-v8a \
            --platform android \
            --assets ./public
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: MagicSub
          path: Sub-Store/backend/dist/MagicSub
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.tag }}
          files: Sub-Store/backend/dist/MagicSub
          generate_release_notes: true