name: Build Node.js for Android ARM64

on:
  workflow_dispatch:  # 允许手动触发
  schedule:
    - cron: '0 */6 * * *'  # 每6小时检查一次
  push:
    paths:
      - '.github/workflows/build.yml'  # 当工作流文件更改时触发
    branches:
      - master
  
jobs:
  check-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check latest Node.js version
        id: check
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/nodejs/node/releases/latest | jq -r .tag_name)
          LOCAL_TAG=$(cat .last_built_version 2>/dev/null || echo "none")
          if [ "$LATEST_TAG" != "$LOCAL_TAG" ]; then
            echo "new_version=true" >> $GITHUB_OUTPUT
            echo "$LATEST_TAG" > .last_built_version
            echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup build environment
        if: steps.check.outputs.new_version == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 g++ make python3-pip
          
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r25c
          add-to-path: true

      - name: Set NDK path
        if: steps.check.outputs.new_version == 'true'
        run: echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV

      - name: Clone Node.js repository
        if: steps.check.outputs.new_version == 'true'
        run: |
          git clone https://github.com/nodejs/node.git
          cd node
          git checkout ${{ steps.check.outputs.version }}
          
      - name: Configure and Build Node.js
        env:
          NDK_PATH: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          GYP_DEFINES: "target_arch=arm64 v8_target_arch=arm64 android_target_arch=arm64 host_os=linux OS=android android_ndk_path=${{ steps.setup-ndk.outputs.ndk-path }}"
        run: |
          cd node
          
          # 设置交叉编译环境
          TOOLCHAIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64
          export PATH=$TOOLCHAIN/bin:$PATH
          export CC=$TOOLCHAIN/bin/aarch64-linux-android21-clang
          export CXX=$TOOLCHAIN/bin/aarch64-linux-android21-clang++
          export LINK=$CXX
          export AR=$TOOLCHAIN/bin/llvm-ar
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          
          # 显示环境信息
          echo "NDK_PATH: $NDK_PATH"
          echo "ANDROID_NDK_ROOT: $ANDROID_NDK_ROOT"
          echo "GYP_DEFINES: $GYP_DEFINES"
          
          # 创建符号链接以确保路径正确
          sudo ln -sf $NDK_PATH /android-ndk
          
          # 配置 Node.js
          ./configure \
            --dest-cpu=arm64 \
            --dest-os=android \
            --cross-compiling \
            --openssl-no-asm
          
          make -j$(nproc)
          
      - name: Strip binary
        run: |
          cd node
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip out/Release/node
          
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            node/out/Release/node
          name: Node.js for Android ARM64
          body: Automated build of Node.js for Android ARM64
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
