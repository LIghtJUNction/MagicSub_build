name: Build Node.js for Android ARM64

on:
  workflow_dispatch:  # 允许手动触发
  schedule:
    - cron: '0 */6 * * *'  # 每6小时检查一次
  
jobs:
  check-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check latest Node.js version
        id: check
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/nodejs/node/releases/latest | jq -r .tag_name)
          LOCAL_TAG=$(cat .last_built_version 2>/dev/null || echo "none")
          if [ "$LATEST_TAG" != "$LOCAL_TAG" ]; then
            echo "new_version=true" >> $GITHUB_OUTPUT
            echo "$LATEST_TAG" > .last_built_version
            echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup build environment
        if: steps.check.outputs.new_version == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 g++ make python3-pip
          
      - name: Setup Android NDK
        if: steps.check.outputs.new_version == 'true'
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
          
      - name: Clone Node.js repository
        if: steps.check.outputs.new_version == 'true'
        run: |
          git clone https://github.com/nodejs/node.git
          cd node
          git checkout ${{ steps.check.outputs.version }}
          
      - name: Configure and Build Node.js
        env:
          ANDROID_NDK_HOME: ${{ github.workspace }}/android-ndk
        run: |
          cd node
          ./configure --dest-cpu=arm64 --dest-os=android --cross-compiling
          make -j$(nproc)
          
      - name: Strip binary
        run: |
          cd node
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip out/Release/node
          
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            node/out/Release/node
          name: Node.js for Android ARM64
          body: Automated build of Node.js for Android ARM64
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
